# FROM registry.access.redhat.com/ubi9/ubi-minimal:9.7-1764794109
FROM quay.io/hummingbird/python:latest-builder

LABEL name="turnpike-nginx-prometheus" \
      summary="Red Hat Insights Turnpike Nginx Prometheus Exporter" \
      description="Prometheus metrics exporter for Turnpike Nginx proxy. Exposes Nginx metrics for monitoring and observability." \
      io.k8s.description="Prometheus metrics exporter for Turnpike Nginx proxy. Exposes Nginx metrics for monitoring and observability." \
      io.k8s.display-name="Red Hat Insights Turnpike Nginx Prometheus Exporter" \
      io.openshift.tags="insights,turnpike,nginx,prometheus,metrics,monitoring" \
      com.redhat.component="turnpike-nginx-prometheus" \
      version="1.0" \
      release="1" \
      vendor="Red Hat, Inc." \
      url="https://github.com/RedHatInsights/turnpike" \
      distribution-scope="private" \
      maintainer="platform-accessmanagement@redhat.com"

USER root

ENV SCRAPE_URI=http://localhost:8080/stub_status

# RUN microdnf install -y tar git-core make && \
#     microdnf clean all

RUN dnf install -y tar git-core make curl gzip && \
    dnf clean all

# Install Go 1.25.5 to address CVE-2025-61729, CVE-2025-61727 & CVE-2025-4598 (Until new ubi9 minimal image supports this go version)
RUN curl -LO https://go.dev/dl/go1.25.5.linux-amd64.tar.gz && \
    rm -rf /usr/local/go && \
    tar -C /usr/local -xzf go1.25.5.linux-amd64.tar.gz && \
    rm go1.25.5.linux-amd64.tar.gz

ENV PATH="/usr/local/go/bin:${PATH}"

RUN git clone --branch v1.5.1 https://github.com/nginx/nginx-prometheus-exporter && \
    cd nginx-prometheus-exporter && \
    make && \
    chmod +x ./nginx-prometheus-exporter

WORKDIR /nginx-prometheus-exporter

CMD ./nginx-prometheus-exporter --nginx.scrape-uri $SCRAPE_URI
