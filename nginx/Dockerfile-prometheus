FROM registry.access.redhat.com/ubi9/ubi-minimal:9.7-1769056855

LABEL name="turnpike-nginx-prometheus" \
      summary="Red Hat Insights Turnpike Nginx Prometheus Exporter" \
      description="Prometheus metrics exporter for Turnpike Nginx proxy. Exposes Nginx metrics for monitoring and observability." \
      io.k8s.description="Prometheus metrics exporter for Turnpike Nginx proxy. Exposes Nginx metrics for monitoring and observability." \
      io.k8s.display-name="Red Hat Insights Turnpike Nginx Prometheus Exporter" \
      io.openshift.tags="insights,turnpike,nginx,prometheus,metrics,monitoring" \
      com.redhat.component="turnpike-nginx-prometheus" \
      version="1.0" \
      release="1" \
      vendor="Red Hat, Inc." \
      url="https://github.com/RedHatInsights/turnpike" \
      distribution-scope="private" \
      maintainer="platform-accessmanagement@redhat.com"

USER root

ENV SCRAPE_URI=http://localhost:8080/stub_status

RUN microdnf update -y curl-minimal libcurl-minimal glib2 && \
    microdnf install -y tar git-core make && \
    microdnf clean all

RUN curl -fsSL https://go.dev/dl/go1.25.6.linux-amd64.tar.gz | tar -C /usr/local -xzf - && \
    export PATH=$PATH:/usr/local/go/bin && \
    git clone --branch v1.5.1 https://github.com/nginxinc/nginx-prometheus-exporter && \
    cd nginx-prometheus-exporter && \
    make && \
    chmod +x ./nginx-prometheus-exporter

WORKDIR /nginx-prometheus-exporter

CMD ./nginx-prometheus-exporter --nginx.scrape-uri $SCRAPE_URI
